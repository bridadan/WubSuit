#include <inttypes.h>
#include <stdio.h>
#include "drivers/CoreUARTapb/core_uart_apb.h"
#include "drivers/mss_gpio/mss_gpio.h"

#define BAUD_VALUE_115200    53 //Possibly a problem because not exactly 53 (53.2535)
#define COREUARTAPB0_BASE_ADDR      0x40050000
#define MAX_RX_DATA_SIZE    256

uint32_t * P_WDG_ENABLE = (uint32_t *)(0x40006010);
UART_instance_t XBee_uart;

__attribute__ ((interrupt)) void GPIO0_IRQHandler( void )
{

	uint8_t rx_data[MAX_RX_DATA_SIZE];
	uint8_t rx_size = 0;
	rx_size = UART_get_rx( &XBee_uart, rx_data, sizeof(rx_data) );

    printf("Interrupt occurred - GPIO 0 \n\r");
    printf("Received %u bytes of data\n\r", rx_size);

    for (; rx_size >= 0; rx_size--) {
    	printf("Data at %u was %u\n\r", rx_size, rx_data[rx_size]);
    }

    MSS_GPIO_clear_irq( MSS_GPIO_0 );
    NVIC_ClearPendingIRQ( GPIO0_IRQn );
}

int main()
{
	printf("Starting...\n\r");
	/* Disable Watchdog Timer*/
	*P_WDG_ENABLE = 0x4C6E55FA;

	// Initialize GPIO
	MSS_GPIO_init();
	MSS_GPIO_config( MSS_GPIO_0, MSS_GPIO_INPUT_MODE | MSS_GPIO_IRQ_EDGE_POSITIVE );
	MSS_GPIO_enable_irq( MSS_GPIO_0 );
	NVIC_EnableIRQ(GPIO0_IRQn);

	// Initialize UART
	UART_init(&XBee_uart, COREUARTAPB0_BASE_ADDR, BAUD_VALUE_115200, (DATA_8_BITS | NO_PARITY));
	uint8_t data[1] = { 0x69 };

	int i;
	//for (i = 0; i < 3; i++) {
		printf("**0** Sending UART\n\r");
		UART_send(&XBee_uart, data, 1);
	//}

	while (1) {
		// wait
	}

	return 0;
}

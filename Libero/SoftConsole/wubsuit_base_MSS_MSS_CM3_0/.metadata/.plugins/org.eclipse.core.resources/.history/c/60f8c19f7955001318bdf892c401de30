#ifndef MENU_H_
#define MENU_H_

#define MENU_COUNT 5
#define MAX_SUBMENUS 10
#define MAX_NAME 20

#include "lcd.h"

typedef struct _Menu {
	char* name;
	void (*command)();
	uint8_t submenusCount;
	struct _Menu* submenus[MAX_SUBMENUS];
} Menu;

struct MenuState {
	Menu* currentMenu;
	uint8_t selectedMenu;
	Menu menus[MENU_COUNT];
} menuState;

void Menu_init() {
	menuState.currentMenu = 0;
	menuState.selectedMenu = 0;

	menuState.menus[0].name = "Main Menu";
	menuState.menus[0].submenusCount = 2;

	// Main Menus

	menuState.menus[1].name = "Note Output";
	menuState.menus[1].submenusCount = 1;

	menuState.menus[2].name = "MIDI Mappings";
	menuState.menus[2].submenusCount = 1;

	menuState.menus[0].submenus[0] = &(menuState.menus[1]);
	menuState.menus[0].submenus[1] = &(menuState.menus[2]);

	// Level 1

	menuState.menus[3].name = "Left Foot";
	menuState.menus[3].submenusCount = 1;

	menuState.menus[2].submenus[0] = &(menuState.menus[3]);

	//menuState.menus[4].name = NoteNames[settings.LPiezoMapping];
	menuState.menus[4].submenusCount = 0;
	//menuState.menus[4].command = Menu_LPiezoOptionCmd;

	menuState.menus[3].submenus[0] = &(menuState.menus[4]);
}

void Menu_setMenu(Menu* menu) {
	menuState.currentMenu = menu;
	menuState.selectedMenu = 0;
}

void Menu_moveDown() {
	if (menuState.selectedMenu < menuState.currentMenu->submenusCount - 1) {
		menuState.selectedMenu++;
		LCD_setSelectorPosition(menuState.selectedMenu);
	}
}

void Menu_moveUp() {
	if (menuState.selectedMenu > 0) {
		menuState.selectedMenu--;
		LCD_moveSelector(menuState.selectedMenu);
	}
}

void Menu_displayMenu(Menu* menu) {
	volatile uint8_t i;

	LCD_setSelectorPosition(0);
	LCD_drawString(menu->name, 10, 0);

	for (i = 0; i < menu->submenusCount; i++) {
		LCD_drawString((menu->submenus[i])->name, 10, (LCD_LINE_HEIGHT * (i + 1)));
	}
}

void Menu_select(Menu* menu, uint8_t selectedMenu) {
	if (menu->submenus[selectedMenu]->submenusCount == 0) {
		// Option selected, execute command
	} else {
		Menu_setMenu(menu->submenus[selectedMenu]);
		Menu_displayMenu(menuState.selectedMenu);
	}
}

#endif /* MENU_H_ */
